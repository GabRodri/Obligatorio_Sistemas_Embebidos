<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos Registrados</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Eventos Registrados</h1>
            <a href="{{ url_for('index') }}" class="btn btn-back">‚Üê Volver al Inicio</a>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="stats-quick">
            <div class="stats-mini">
                <div class="stat-mini">
                    <span class="stat-mini-label">Total Eventos</span>
                    <span class="stat-mini-value">{{ eventos|length }}</span>
                </div>
                <div class="stat-mini">
                    <span class="stat-mini-label">Autorizados</span>
                    <span class="stat-mini-value success">
                        {{ eventos|selectattr("3")|list|length }}
                    </span>
                </div>
                <div class="stat-mini">
                    <span class="stat-mini-label">Denegados</span>
                    <span class="stat-mini-value danger">
                        {{ eventos|rejectattr("3")|list|length }}
                    </span>
                </div>
            </div>
        </section>

        <section class="list-section">
            <div class="section-header">
                <h2>Historial de Eventos</h2>
                <div class="section-actions">
                    <button onclick="recargarEventos()" class="btn btn-secondary">üîÑ Actualizar</button>
                    <a href="{{ url_for('consultar_eventos') }}" class="btn btn-primary">üìÖ Consultar por Fecha</a>
                </div>
            </div>

            {% if eventos %}
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Identificaci√≥n</th>
                            <th>Nombre</th>
                            <th>Fecha y Hora</th>
                            <th>Autorizado</th>
                            <th>Canal</th>
                            <th>Operaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for evento in eventos %}
                        <tr class="{{ 'row-authorized' if evento[3] else 'row-denied' }}">

                            <!-- ID -->
                            <td><code>#{{ evento[0] }}</code></td>

                            <!-- Identificaci√≥n -->
                            <td>
                                <strong>{{ evento[1] }}</strong>
                                {% if evento[1]|length == 8 %}
                                <span class="badge badge-secondary">C√©dula</span>
                                {% else %}
                                <span class="badge badge-info">RFID</span>
                                {% endif %}
                            </td>

                            <!-- Nombre (evento[6]) -->
                            <td>
                                {% if evento[6] %}
                                {{ evento[6] }}
                                {% else %}
                                <span class="text-muted">No registrado</span>
                                {% endif %}
                            </td>

                            <!-- Fecha -->
                            <td>
                                <span class="datetime">{{ evento[2] }}</span>
                            </td>

                            <!-- Autorizado -->
                            <td>
                                <span class="badge {{ 'badge-success' if evento[3] else 'badge-danger' }}">
                                    {{ '‚úÖ S√≠' if evento[3] else '‚ùå No' }}
                                </span>
                            </td>

                            <!-- Canal -->
                            <td>
                                {% if evento[4] == 'rfid' %}
                                    <span class="badge badge-info">üì° RFID</span>
                                {% elif evento[4] == 'serial' %}
                                    <span class="badge badge-primary">üîå Serial</span>
                                {% else %}
                                    <span class="badge badge-warning"> </span>
                                {% endif %}
                            </td>

                            <!-- Operaci√≥n (evento[5]) -->
                            <td>
                                <span class="badge
                                    {% if evento[5] == 'acceso' %}badge-secondary
                                    {% elif evento[5] == 'alta' %}badge-success
                                    {% elif evento[5] == 'baja' %}badge-danger
                                    {% else %}badge-warning{% endif %}">

                                    {% if evento[5] == 'acceso' %}üö™ Acceso
                                    {% elif evento[5] == 'alta' %}‚ûï Alta
                                    {% elif evento[5] == 'baja' %}‚ûñ Baja
                                    {% else %}{{ evento[5] }}{% endif %}
                                </span>
                            </td>

                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>

            <div class="table-footer">
                <p>Mostrando los √∫ltimos <strong>{{ eventos|length }}</strong> eventos registrados</p>
            </div>
            {% else %}
            <div class="empty-state">
                <h3>üìä No hay eventos registrados</h3>
                <p>No se han registrado eventos en el sistema a√∫n.</p>
                <p>Los eventos se registran autom√°ticamente a trav√©s de la API.</p>
            </div>
            {% endif %}
        </section>
    </div>

    <script>
        function recargarEventos() {
            location.reload();
        }

        // Convertir fechas a formato local
        document.addEventListener('DOMContentLoaded', function() {
            const dateElements = document.querySelectorAll('.datetime');
            dateElements.forEach(el => {
                const originalDate = el.textContent;
                const date = new Date(originalDate);
                el.textContent = date.toLocaleString('es-ES');
                el.title = originalDate;
            });
        });
    </script>
</body>
</html>
