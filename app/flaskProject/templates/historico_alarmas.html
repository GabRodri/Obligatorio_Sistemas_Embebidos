<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico de Alarmas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">

        <header>
            <h1>Hist√≥rico de Alarmas</h1>
            <a href="{{ url_for('index') }}" class="btn btn-back">‚Üê Volver al Inicio</a>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="stats-quick">
            <div class="stats-mini">
                <div class="stat-mini">
                    <span class="stat-mini-label">Total Alarmas</span>
                    <span class="stat-mini-value">{{ alarmas|length }}</span>
                </div>

                <div class="stat-mini">
                    <span class="stat-mini-label">Alarmas Activas</span>
                    <span class="stat-mini-value danger">
                        {{ alarmas|selectattr("3")|list|length }}
                    </span>
                </div>

                <div class="stat-mini">
                    <span class="stat-mini-label">Alarmas Inactivas</span>
                    <span class="stat-mini-value success">
                        {{ alarmas|rejectattr("3")|list|length }}
                    </span>
                </div>
            </div>
        </section>

        <section class="list-section">
            <div class="section-header">
                <h2>Registro de Alarmas</h2>
                <div class="section-actions">
                    <button onclick="recargarAlarmas()" class="btn btn-secondary">üîÑ Actualizar</button>
                </div>
            </div>

            {% if alarmas %}
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha y Hora</th>
                            <th>Estado</th>
                            <th>Canal</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for alarma in alarmas %}
                        <tr class="{{ 'row-denied' if alarma[3] else 'row-authorized' }}">

                            <!-- ID -->
                            <td><code>#{{ alarma[0] }}</code></td>

                            <!-- Fecha -->
                            <td><span class="datetime">{{ alarma[2] }}</span></td>

                            <!-- Estado -->
                            <td>
                                <span class="badge {{ 'badge-danger' if alarma[3] else 'badge-success' }}">
                                    {{ 'üö® Activada' if alarma[3] else '‚úî Normal' }}
                                </span>
                            </td>

                            <!-- Canal -->
                            <td>
                                <span class="badge badge-warning">üîî Alarma</span>
                            </td>

                            <!-- Detalles -->
                            <td>
                                {% if alarma[5] %}
                                    <span class="badge badge-info">{{ alarma[5] }}</span>
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>

                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>

            <div class="table-footer">
                <p>Mostrando <strong>{{ alarmas|length }}</strong> registros de alarma</p>
            </div>

            {% else %}
            <div class="empty-state">
                <h3>üîî No hay alarmas registradas</h3>
                <p>El sistema no ha registrado alarmas a√∫n.</p>
            </div>
            {% endif %}
        </section>

    </div>

    <script>
        function recargarAlarmas() {
            location.reload();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const dateElements = document.querySelectorAll('.datetime');
            dateElements.forEach(el => {
                const originalDate = el.textContent;
                const date = new Date(originalDate);
                el.textContent = date.toLocaleString('es-ES');
                el.title = originalDate;
            });
        });
    </script>

</body>
</html>
